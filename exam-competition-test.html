<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¯•å·ç«èµ›æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f7fa;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
      }

      .header h1 {
        color: #409eff;
        margin: 0;
      }

      .header p {
        color: #666;
        margin: 10px 0;
      }

      .control-panel {
        background: white;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .status-panel {
        background: white;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .log-panel {
        background: white;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .ai-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }

      .ai-card {
        background: white;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        padding: 15px;
      }

      .ai-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #409eff;
      }

      .ai-status {
        margin: 10px 0;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .status-ready {
        background: #f0f9ff;
        color: #67c23a;
      }

      .status-working {
        background: #e6f7ff;
        color: #1890ff;
      }

      .status-error {
        background: #fef0f0;
        color: #f56c6c;
      }

      .ai-content {
        margin: 10px 0;
        font-size: 13px;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      .log-content {
        background: #f9f9f9;
        border: 1px solid #e4e7ed;
        border-radius: 4px;
        padding: 15px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }

      .log-success {
        color: #67c23a;
      }

      .log-error {
        color: #f56c6c;
      }

      .log-info {
        color: #1890ff;
      }

      .log-warning {
        color: #e6a23c;
      }

      button {
        padding: 12px 24px;
        background: #409eff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        font-weight: bold;
      }

      button:hover {
        background: #66b1ff;
      }

      button:disabled {
        background: #909399;
        cursor: not-allowed;
      }

      .big-button {
        padding: 20px 40px;
        font-size: 18px;
        background: linear-gradient(135deg, #409eff, #66b1ff);
      }

      .big-button:hover {
        background: linear-gradient(135deg, #66b1ff, #409eff);
      }

      .results-panel {
        background: white;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: #f9f9f9;
        border-radius: 4px;
      }

      .ranking-medal {
        font-size: 24px;
        margin-right: 10px;
      }

      .cumulative-controls {
        margin: 15px 0;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .sort-btn {
        padding: 8px 16px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
      }

      .sort-btn:hover {
        background: #e0e0e0;
      }

      .sort-btn.active {
        background: #409eff;
        color: white;
        border-color: #409eff;
      }

      .cumulative-stats {
        display: grid;
        grid-template-columns: 80px 120px 60px 60px 60px 80px 80px;
        gap: 5px;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 12px;
      }

      .cumulative-stats.header {
        font-weight: bold;
        background: #f9f9f9;
      }

      .history-panel {
        background: white;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }

      .history-item:last-child {
        border-bottom: none;
      }

      .history-time {
        color: #666;
        font-size: 12px;
      }

      .history-info {
        flex-grow: 1;
        margin: 0 15px;
      }

      .history-actions {
        display: flex;
        gap: 8px;
      }

      .btn-small {
        padding: 4px 8px;
        font-size: 12px;
        background: #409eff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-small:hover {
        background: #66b1ff;
      }

      .btn-danger {
        background: #f56c6c;
      }

      .btn-danger:hover {
        background: #f78989;
      }

      .ranking-name {
        font-weight: bold;
        flex-grow: 1;
      }

      .ranking-score {
        color: #409eff;
        font-weight: bold;
      }

      .feature-highlight {
        background: #fff7e6;
        border: 1px solid #e6a23c;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¤– AIé—®ç­”ç«èµ›æµ‹è¯•</h1>
        <p>å‡ºé¢˜-éšæœºåˆ†é…-å›ç­”-è¯„åˆ†-æ’å</p>
      </div>

      <div class="feature-highlight">
        <h3>ç«èµ›æµç¨‹</h3>
        <ul>
          <li><strong>é˜¶æ®µ1</strong>: 4ä¸ªAIéšæœºé¡ºåºå‡ºé¢˜ï¼ˆæ¯äºº1é¢˜ï¼‰</li>
          <li><strong>é˜¶æ®µ2</strong>: æŒ‰å‡ºé¢˜é¡ºåºå¾ªç¯åˆ†é…é¢˜ç›®ä½œç­”</li>
          <li><strong>é˜¶æ®µ3</strong>: å‡ºé¢˜è€…å¯¹ç­”æ¡ˆè¿›è¡Œè¯„åˆ†ï¼ˆå«è¯¦ç»†ç†ç”±ï¼‰</li>
          <li><strong>é˜¶æ®µ4</strong>: ç»Ÿè®¡å„AIå¹³å‡å¾—åˆ†å¹¶æ’å</li>
        </ul>
      </div>

      <div class="control-panel">
        <h3>ç«èµ›æ§åˆ¶</h3>
        <div style="margin-bottom: 15px;">
          <label><strong>ç«èµ›ä¸»é¢˜ï¼š</strong></label>
          <input type="text" id="competition-theme" value="äººå·¥æ™ºèƒ½" placeholder="è¯·è¾“å…¥ç«èµ›ä¸»é¢˜" style="width: 200px; padding: 5px; margin-left: 10px;">
          <button onclick="updateTheme()" class="small-button">æ›´æ–°ä¸»é¢˜</button>
        </div>
        <button onclick="startCompetition()" id="start-btn" class="big-button">å¼€å§‹AIé—®ç­”ç«èµ›</button>
        <button onclick="resumeCompetition()" id="resume-btn" disabled>
          ç»§ç»­æ¯”èµ›
        </button>
        <button onclick="clearCheckpoint()" id="clear-btn" class="small-button">
          æ¸…é™¤æ–­ç‚¹
        </button>
        <button onclick="exportCheckpoint()" id="export-checkpoint-btn" class="small-button">
          å¯¼å‡ºæ–­ç‚¹
        </button>
        <button onclick="importCheckpoint()" id="import-checkpoint-btn" class="small-button">
          å¯¼å…¥æ–­ç‚¹
        </button>
        <div style="margin-top: 10px;">
          <label>AIçª—å£å­—ä½“å¤§å°ï¼š</label>
          <select id="font-size-select" onchange="changeAIFontSize(this.value)">
            <option value="12px">å°</option>
            <option value="13px" selected>ä¸­</option>
            <option value="14px">å¤§</option>
            <option value="15px">ç‰¹å¤§</option>
          </select>
        </div>
        <div style="margin-top: 10px;">
          <label><strong>ğŸ“¦ Gitå¤‡ä»½ï¼š</strong></label>
          <button onclick="performGitBackup()" class="small-button">ç«‹å³å¤‡ä»½</button>
          <button onclick="syncFromGit()" class="small-button">åŒæ­¥æ•°æ®</button>
          <button onclick="showBackupHistory()" class="small-button">å¤‡ä»½å†å²</button>
        </div>
        <div id="progress-text">å‡†å¤‡å°±ç»ª</div>
      </div>

      <div class="history-panel">
        <h3>ğŸ“š å†å²è®°å½•</h3>
        <div id="history-list"></div>
      </div>

      <div class="status-panel">
        <h3>AIé€‰æ‰‹çŠ¶æ€</h3>
        <div class="ai-grid" id="ai-grid"></div>
      </div>

      <div class="results-panel" id="results-panel" style="display: none">
        <h3>ğŸ† æœ€ç»ˆæ’å</h3>
        <div id="ranking-list"></div>

        <h3>ğŸ“Š ç´¯ç§¯åæ¬¡ç»Ÿè®¡</h3>
        <div class="cumulative-controls">
            <button onclick="showCumulativeRanking('gold')" class="sort-btn active" data-sort="gold">ğŸ¥‡ æŒ‰é‡‘ç‰Œæ’åº</button>
            <button onclick="showCumulativeRanking('silver')" class="sort-btn" data-sort="silver">ğŸ¥ˆ æŒ‰é“¶ç‰Œæ’åº</button>
            <button onclick="showCumulativeRanking('bronze')" class="sort-btn" data-sort="bronze">ğŸ¥‰ æŒ‰é“œç‰Œæ’åº</button>
            <button onclick="showCumulativeRanking('total')" class="sort-btn" data-sort="total">ğŸ“ˆ æŒ‰æ€»åˆ†æ’åº</button>
            <button onclick="showCumulativeRanking('avg')" class="sort-btn" data-sort="avg">ğŸ’¯ æŒ‰å¹³å‡åˆ†æ’åº</button>
        </div>
        <div id="cumulative-ranking-list"></div>
    </div>

    <!-- å†å²è®°å½•æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="history-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: relative; width: 90%; height: 90%; margin: 2% auto; background: white; border-radius: 8px; overflow: hidden;">
            <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ“– å†å²æ¯”èµ›è¯¦æƒ…</h3>
                <div>
                    <button onclick="exportHistoryResult()" class="btn-small">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
                    <button onclick="closeHistoryModal()" class="btn-small btn-danger">âœ– å…³é—­</button>
                </div>
            </div>
            <div id="history-content" style="padding: 20px; height: calc(100% - 80px); overflow-y: auto;">
                <!-- å†å²å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

      <div class="log-panel">
        <h3>ç«èµ›æ—¥å¿—</h3>
        <div class="log-content" id="log-content"></div>
      </div>
    </div>

    <script src="git-manager.js"></script>
    <script src="ai-exam-competition-engine.js"></script>
    <script>
      let competition = null;
      let currentHistoryId = null;
      let gitManager = null;

      function initializeCompetition() {
        competition = new AIExamCompetition();

        // åˆå§‹åŒ–Gitç®¡ç†å™¨
        gitManager = new GitManager();

        competition.onLogCallback = (message, type) => {
          addLog(message, type);
        };

        competition.onStatusUpdateCallback = (playerId, status) => {
          updateAIStatus(playerId, status);
        };

        window.updateAIDetailContent = (playerId, type, content) => {
          updateAIDetail(playerId, type, content);
        };

        competition.setupPlayers(['deepseek', 'claude', 'grok', 'chatgpt']);
        renderAIGrid();
        addLog("ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª", "success");

        updateCheckpointButtons();
      }

      function updateCheckpointButtons() {
        const storageOk =
          competition &&
          competition.isCheckpointStorageAvailable &&
          competition.isCheckpointStorageAvailable();
        const has =
          storageOk &&
          competition &&
          competition.hasCheckpoint &&
          competition.hasCheckpoint();
        document.getElementById("resume-btn").disabled = !has;
        document.getElementById("clear-checkpoint-btn").disabled = !has;
        document.getElementById("export-checkpoint-btn").disabled = !has;

        if (!storageOk) {
          addLog(
            "æ£€æµ‹åˆ°æ–­ç‚¹å­˜å‚¨ä¸å¯ç”¨ï¼ˆå¸¸è§äºç›´æ¥ç”¨file://æ‰“å¼€ï¼‰ã€‚å»ºè®®ç”¨æœ¬åœ°HTTPæœåŠ¡å™¨æ–¹å¼æ‰“å¼€é¡µé¢ï¼Œå¦åˆ™æ— æ³•æ–­ç‚¹ç»­è·‘ã€‚",
            "warning",
          );
        } else if (has) {
          addLog(
            'æ£€æµ‹åˆ°ä¸Šæ¬¡æ¯”èµ›æ–­ç‚¹ï¼šå¯ä»¥ç‚¹å‡»"ç»§ç»­æ¯”èµ›"ä»æ–­ç‚¹æ¢å¤ã€‚',
            "warning",
          );
        }
      }

      function renderAIGrid() {
        const grid = document.getElementById("ai-grid");
        grid.innerHTML = competition.players
          .map(
            (player) => `
                <div class="ai-card">
                    <div class="ai-title">${player.name}</div>
                    <div class="ai-status status-ready" id="status-${player.id}">å‡†å¤‡å°±ç»ª</div>
                    <div class="ai-content">
                        <div><strong id="question-label-${player.id}">å‡ºé¢˜å†…å®¹ï¼š</strong></div>
                        <div id="question-${player.id}">ç­‰å¾…å‡ºé¢˜...</div>
                        <div style="margin-top:8px;"><strong id="answer-label-${player.id}">æ”¶åˆ°ç­”æ¡ˆï¼š</strong></div>
                        <div id="answer-${player.id}">ç­‰å¾…å…¶ä»–AIå›ç­”...</div>
                        <div style="margin-top:8px;"><strong id="scoring-label-${player.id}">è¯„åˆ†å†…å®¹ï¼š</strong></div>
                        <div id="scoring-${player.id}">ç­‰å¾…è¯„åˆ†...</div>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function updateAIStatus(playerId, status) {
        const el = document.getElementById(`status-${playerId}`);
        if (!el) return;
        el.textContent = status;
        el.className = `ai-status ${getStatusClass(status)}`;
      }

      function updateAIDetail(playerId, type, content) {
        const el = document.getElementById(`${type}-${playerId}`);
        if (!el) return;
        el.textContent = content;
      }

      function getStatusClass(status) {
        if (status.includes("ä¸­")) return "status-working";
        if (status.includes("å¤±è´¥") || status.includes("é”™è¯¯"))
          return "status-error";
        return "status-ready";
      }

      function addLog(message, type = "info") {
        const logContent = document.getElementById("log-content");
        const timestamp = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = `log-${type}`;
        div.textContent = `[${timestamp}] ${message}`;
        logContent.appendChild(div);
        logContent.scrollTop = logContent.scrollHeight;
      }

      async function startCompetition(resume = false) {
        if (!competition) {
          initializeCompetition();
          await new Promise((resolve) => setTimeout(resolve, 300));
        }

        document.getElementById("start-btn").disabled = true;
        document.getElementById("results-panel").style.display = "none";
        document.getElementById("progress-text").textContent = "ç«èµ›è¿›è¡Œä¸­...";

        try {
          await competition.run({ resume });
          showResults();
          document.getElementById("progress-text").textContent = "ç«èµ›å®Œæˆ";
        } catch (e) {
          addLog(`ç«èµ›å¤±è´¥: ${e.message}`, "error");
          addLog(
            "å¦‚æœä½ åˆšæé«˜äº†é¢åº¦æˆ–ä¿®å¤äº†APIé—®é¢˜ï¼Œå¯ä»¥ç‚¹å‡»â€œç»§ç»­æ¯”èµ›â€ä»æ–­ç‚¹æ¢å¤ã€‚",
            "warning",
          );
          document.getElementById("progress-text").textContent = "ç«èµ›å¤±è´¥";
        } finally {
          document.getElementById("start-btn").disabled = false;
          updateCheckpointButtons();
        }
      }

      async function resumeCompetition() {
        await startCompetition(true);
      }

      function clearCheckpoint() {
        if (!competition) {
          initializeCompetition();
        }
        if (competition && competition.clearCheckpoint) {
          competition.clearCheckpoint();
        }
        addLog("æ–­ç‚¹å·²æ¸…é™¤", "success");
        updateCheckpointButtons();
      }

      function showResults() {
        const panel = document.getElementById("results-panel");
        const list = document.getElementById("ranking-list");
        panel.style.display = "block";

        const ranking = competition.finalRanking || [];
        list.innerHTML = ranking
          .map((r, idx) => {
            const medal =
              idx === 0 ? "ğŸ¥‡" : idx === 1 ? "ğŸ¥ˆ" : idx === 2 ? "ğŸ¥‰" : "  ";
            return `
                    <div class="ranking-item">
                        <div style="display:flex; align-items:center;">
                            <span class="ranking-medal">${medal}</span>
                            <span class="ranking-name">${r.name}</span>
                        </div>
                        <span class="ranking-score">${Number(r.avgScore).toFixed(2)}åˆ†</span>
                    </div>
                `;
          })
          .join("");

        // æ˜¾ç¤ºç´¯ç§¯ç»Ÿè®¡
        showCumulativeRanking('gold');

        // ä¿å­˜å†å²è®°å½•
        saveHistory();

        // è‡ªåŠ¨å¤‡ä»½åˆ°Git
        if (gitManager) {
          setTimeout(async () => {
            addLog('ğŸ”„ æ¯”èµ›ç»“æŸï¼Œå¼€å§‹è‡ªåŠ¨å¤‡ä»½...', 'info');
            await performGitBackup();
          }, 2000);
        }
      }

      function showCumulativeRanking(sortBy) {
        const list = document.getElementById("cumulative-ranking-list");
        const ranking = competition.getCumulativeRanking(sortBy);

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.sort-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-sort="${sortBy}"]`).classList.add('active');

        // è¡¨å¤´
        let html = `
          <div class="cumulative-stats header">
            <div>æ’å</div>
            <div>AIåç§°</div>
            <div>ğŸ¥‡é‡‘ç‰Œ</div>
            <div>ğŸ¥ˆé“¶ç‰Œ</div>
            <div>ğŸ¥‰é“œç‰Œ</div>
            <div>æ€»åˆ†</div>
            <div>å¹³å‡åˆ†</div>
          </div>
        `;

        // æ•°æ®è¡Œ
        ranking.forEach((stats, idx) => {
          const avgScore = stats.competitions > 0 ? (stats.totalScore / stats.competitions).toFixed(2) : '0.00';
          const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `${idx + 1}.`;

          html += `
            <div class="cumulative-stats">
              <div>${medal}</div>
              <div>${stats.name}</div>
              <div>${stats.goldCount}</div>
              <div>${stats.silverCount}</div>
              <div>${stats.bronzeCount}</div>
              <div>${stats.totalScore.toFixed(2)}</div>
              <div>${avgScore}</div>
            </div>
          `;
        });

        list.innerHTML = html;
      }

      function resetCompetition() {
        competition = null;
        document.getElementById("log-content").innerHTML = "";
        document.getElementById("results-panel").style.display = "none";
        document.getElementById("progress-text").textContent = "å‡†å¤‡å°±ç»ª";
        initializeCompetition();
        addLog("ç«èµ›å·²é‡ç½®ï¼ˆå†å²è®°å½•å’Œæ–­ç‚¹ä¿ç•™ï¼‰", "info");
      }

      function exportResults() {
        if (!competition) {
          addLog("æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ", "error");
          return;
        }

        const payload = {
          timestamp: new Date().toISOString(),
          competition: "AIé—®ç­”ç«èµ›æµ‹è¯•",
          data: {
            questions: competition.questions,
            answers: competition.answers,
            scores: competition.scores,
            questionAssignments: competition.questionAssignments,
            finalRanking: competition.finalRanking,
          },
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ai-qa-competition-results-${new Date().toISOString().split("T")[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        addLog("ç»“æœå·²å¯¼å‡º", "success");
      }

      function exportCheckpoint() {
        if (!competition) {
          addLog("æ²¡æœ‰å¯å¯¼å‡ºçš„æ–­ç‚¹", "error");
          return;
        }

        const checkpointData = competition.loadCheckpoint();
        if (!checkpointData) {
          addLog("æ²¡æœ‰æ‰¾åˆ°æ–­ç‚¹æ•°æ®", "error");
          return;
        }

        const payload = {
          timestamp: new Date().toISOString(),
          competition: "AIé—®ç­”ç«èµ›æµ‹è¯•",
          type: "checkpoint",
          version: checkpointData.version,
          savedAt: checkpointData.savedAt,
          data: checkpointData,
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ai-qa-competition-checkpoint-${new Date().toISOString().split("T")[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        addLog("æ–­ç‚¹å·²å¯¼å‡º", "success");
      }

      function importCheckpoint() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";

        input.onchange = function (event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const content = e.target.result;
              const parsed = JSON.parse(content);

              // éªŒè¯æ–‡ä»¶æ ¼å¼
              if (!parsed || parsed.type !== "checkpoint" || parsed.competition !== "AIé—®ç­”ç«èµ›æµ‹è¯•") {
                addLog("æ— æ•ˆçš„æ–­ç‚¹æ–‡ä»¶æ ¼å¼", "error");
                return;
              }

              const checkpointData = parsed.data;
              if (!checkpointData || checkpointData.version !== 1) {
                addLog("ä¸æ”¯æŒçš„æ–­ç‚¹ç‰ˆæœ¬", "error");
                return;
              }

              // ä¿å­˜æ–­ç‚¹åˆ° localStorage
              if (!competition) {
                initializeCompetition();
              }

              localStorage.setItem(
                competition.checkpointKey,
                JSON.stringify(checkpointData),
              );
              addLog(
                `æ–­ç‚¹å·²å¯¼å…¥ï¼Œä¿å­˜æ—¶é—´: ${checkpointData.savedAt}`,
                "success",
              );

              // æ›´æ–°æŒ‰é’®çŠ¶æ€
              updateCheckpointButtons();
            } catch (error) {
              addLog(`å¯¼å…¥å¤±è´¥: ${error.message}`, "error");
            }
          };

          reader.readAsText(file);
        };

        input.click();
      }

      window.onload = function () {
        initializeCompetition();
        loadHistory();
        loadAIFontSize();
        loadTheme();
      };

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          updateCheckpointButtons();
        }
      });

      // å†å²è®°å½•åŠŸèƒ½
      function saveHistory() {
        try {
          const historyData = {
            id: Date.now().toString(),
            timestamp: new Date().toLocaleString(),
            finalRanking: competition.finalRanking,
            cumulativeStats: competition.cumulativeStats,
            players: competition.players.map(p => ({
              id: p.id,
              name: p.name,
              status: p.status,
              authoredQuestion: p.authoredQuestion,
              answers: p.answers,
              finalScore: p.finalScore
            })),
            questions: competition.questions,
            answers: competition.answers,
            scores: competition.scores
          };

          let history = JSON.parse(localStorage.getItem('AICompetitionHistory') || '[]');
          history.unshift(historyData);

          // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
          if (history.length > 20) {
            history = history.slice(0, 20);
          }

          localStorage.setItem('AICompetitionHistory', JSON.stringify(history));
          loadHistory();
        } catch (e) {
          console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
        }
      }

      function loadHistory() {
        const historyList = document.getElementById('history-list');
        try {
          const history = JSON.parse(localStorage.getItem('AICompetitionHistory') || '[]');

          if (history.length === 0) {
            historyList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
            return;
          }

          historyList.innerHTML = history.map(item => {
            const winner = item.finalRanking[0];
            return `
              <div class="history-item">
                <div class="history-time">${item.timestamp}</div>
                <div class="history-info">
                  ğŸ† å† å†›: ${winner.name} (${winner.avgScore.toFixed(2)}åˆ†)
                </div>
                <div class="history-actions">
                  <button onclick="viewHistory('${item.id}')" class="btn-small">ğŸ“– æŸ¥çœ‹</button>
                  <button onclick="deleteHistory('${item.id}')" class="btn-small btn-danger">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
              </div>
            `;
          }).join('');
        } catch (e) {
          historyList.innerHTML = '<div style="color: #f56c6c; text-align: center; padding: 20px;">åŠ è½½å†å²è®°å½•å¤±è´¥</div>';
        }
      }

      function viewHistory(historyId) {
        try {
          const history = JSON.parse(localStorage.getItem('AICompetitionHistory') || '[]');
          const historyData = history.find(item => item.id === historyId);

          if (!historyData) {
            alert('å†å²è®°å½•ä¸å­˜åœ¨');
            return;
          }

          currentHistoryId = historyId;
          const content = document.getElementById('history-content');

          // é‡å»ºå†å²é¡µé¢å†…å®¹
          let html = `
            <div style="background: #f5f7fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h4>ğŸ“… æ¯”èµ›æ—¶é—´: ${historyData.timestamp}</h4>
            </div>

            <div class="status-panel" style="margin-bottom: 20px;">
              <h3>ğŸ¤– AIé€‰æ‰‹çŠ¶æ€</h3>
              <div class="ai-grid">
          `;

          // AIçŠ¶æ€
          historyData.players.forEach(player => {
            html += `
              <div class="ai-card">
                <div class="ai-title">${player.name}</div>
                <div class="ai-status status-ready">${player.status}</div>
                <div class="ai-content">
                  <div><strong>å‡ºé¢˜å†…å®¹ï¼š</strong></div>
                  <div>${player.authoredQuestion ? JSON.stringify(player.authoredQuestion.question || '') : 'æ— å‡ºé¢˜'}</div>
                  <div style="margin-top:8px;"><strong>å›ç­”å†…å®¹ï¼š</strong></div>
                  <div>${Object.values(player.answers || {}).join('\n') || 'æ— å›ç­”'}</div>
                </div>
              </div>
            `;
          });

          html += `
              </div>
            </div>

            <div class="results-panel" style="display: block; background: white; border: 1px solid #dcdfe6; border-radius: 8px; padding: 20px;">
              <h3>ğŸ† æœ€ç»ˆæ’å</h3>
              <div style="margin-bottom: 20px;">
          `;

          // æ’å
          historyData.finalRanking.forEach((r, idx) => {
            const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `${idx + 1}.`;
            html += `
              <div class="ranking-item">
                <div style="display:flex; align-items:center;">
                  <span class="ranking-medal">${medal}</span>
                  <span class="ranking-name">${r.name}</span>
                </div>
                <span class="ranking-score">${Number(r.avgScore).toFixed(2)}åˆ†</span>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;

          content.innerHTML = html;
          document.getElementById('history-modal').style.display = 'block';
        } catch (e) {
          alert('æŸ¥çœ‹å†å²è®°å½•å¤±è´¥: ' + e.message);
        }
      }

      function closeHistoryModal() {
        document.getElementById('history-modal').style.display = 'none';
        currentHistoryId = null;
      }

      function deleteHistory(historyId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
          try {
            let history = JSON.parse(localStorage.getItem('AICompetitionHistory') || '[]');
            history = history.filter(item => item.id !== historyId);
            localStorage.setItem('AICompetitionHistory', JSON.stringify(history));
            loadHistory();
          } catch (e) {
            alert('åˆ é™¤å†å²è®°å½•å¤±è´¥');
          }
        }
      }

      function exportHistoryResult() {
        if (!currentHistoryId) {
          alert('æ²¡æœ‰é€‰æ‹©çš„å†å²è®°å½•');
          return;
        }

        try {
          const history = JSON.parse(localStorage.getItem('AICompetitionHistory') || '[]');
          const historyData = history.find(item => item.id === currentHistoryId);

          if (!historyData) {
            alert('å†å²è®°å½•ä¸å­˜åœ¨');
            return;
          }

          const exportData = {
            competition: 'AIé—®ç­”ç«èµ›',
            timestamp: historyData.timestamp,
            data: {
              finalRanking: historyData.finalRanking,
              players: historyData.players,
              questions: historyData.questions,
              answers: historyData.answers,
              scores: historyData.scores
            }
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: 'application/json'
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `ai-competition-history-${historyData.timestamp.replace(/[\/\s:]/g, '-')}.json`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
        }
      }

      function changeAIFontSize(fontSize) {
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('AIFontSize', fontSize);

        // æ›´æ–°æ‰€æœ‰AIçª—å£çš„å­—ä½“å¤§å°
        const aiContents = document.querySelectorAll('.ai-content');
        aiContents.forEach(element => {
          element.style.fontSize = fontSize;
        });

        addLog(`ğŸ”¤ AIçª—å£å­—ä½“å¤§å°å·²è°ƒæ•´ä¸º: ${fontSize}`, 'info');
      }

      // é¡µé¢åŠ è½½æ—¶æ¢å¤å­—ä½“å¤§å°è®¾ç½®
      function loadAIFontSize() {
        const savedFontSize = localStorage.getItem('AIFontSize') || '13px';
        document.getElementById('font-size-select').value = savedFontSize;

        const aiContents = document.querySelectorAll('.ai-content');
        aiContents.forEach(element => {
          element.style.fontSize = savedFontSize;
        });
      }

      // ä¸»é¢˜ç®¡ç†åŠŸèƒ½
      function updateTheme() {
        const theme = document.getElementById('competition-theme').value.trim();
        if (!theme) {
          alert('è¯·è¾“å…¥ç«èµ›ä¸»é¢˜');
          return;
        }

        // ä¿å­˜ä¸»é¢˜åˆ°localStorage
        localStorage.setItem('CompetitionTheme', theme);

        // æ›´æ–°ç«èµ›å®ä¾‹çš„ä¸»é¢˜
        if (competition) {
          competition.setTheme(theme);
        }

        addLog(`ğŸ¯ ç«èµ›ä¸»é¢˜å·²æ›´æ–°ä¸º: ${theme}`, 'info');
      }

      // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸»é¢˜
      function loadTheme() {
        const savedTheme = localStorage.getItem('CompetitionTheme') || 'äººå·¥æ™ºèƒ½';
        document.getElementById('competition-theme').value = savedTheme;

        if (competition) {
          competition.setTheme(savedTheme);
        }
      }

      // Gitå¤‡ä»½åŠŸèƒ½
      async function performGitBackup() {
        if (!gitManager) {
          addLog('âŒ Gitç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
          return;
        }

        addLog('ğŸ”„ å¼€å§‹å¤‡ä»½åˆ°Gitee...', 'info');

        try {
          // è°ƒç”¨çœŸæ­£çš„Gitå¤‡ä»½æœåŠ¡å™¨
          const response = await fetch('http://localhost:3000/git-backup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              command: 'backup',
              message: 'AIç«èµ›æ•°æ®æ‰‹åŠ¨å¤‡ä»½'
            })
          });

          const result = await response.json();

          if (result.success) {
            addLog(`âœ… ${result.message}`, 'success');
            if (result.timestamp) {
              addLog(`ğŸ“… å¤‡ä»½æ—¶é—´: ${new Date(result.timestamp).toLocaleString()}`, 'info');
            }
          } else {
            addLog(`âŒ å¤‡ä»½å¤±è´¥: ${result.error}`, 'error');
          }
        } catch (error) {
          addLog(`âŒ å¤‡ä»½å¼‚å¸¸: ${error.message}`, 'error');
          // å¦‚æœæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå›é€€åˆ°æœ¬åœ°å¤‡ä»½
          addLog('âš ï¸ GitæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½', 'warning');
          const localResult = await gitManager.performRealBackup('AIç«èµ›æ•°æ®æœ¬åœ°å¤‡ä»½');
          if (localResult.success) {
            addLog(`âœ… ${localResult.message}`, 'success');
          }
        }
      }

      async function syncFromGit() {
        if (!gitManager) {
          addLog('âŒ Gitç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
          return;
        }

        addLog('ğŸ”„ å¼€å§‹ä»GiteeåŒæ­¥æ•°æ®...', 'info');

        try {
          // è°ƒç”¨çœŸæ­£çš„GitåŒæ­¥æœåŠ¡å™¨
          const response = await fetch('http://localhost:3000/git-backup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              command: 'sync'
            })
          });

          const result = await response.json();

          if (result.success) {
            addLog(`âœ… ${result.message}`, 'success');
            // é‡æ–°åŠ è½½é¡µé¢æ•°æ®
            setTimeout(() => {
              loadHistory();
              loadTheme();
              loadAIFontSize();
              addLog('ğŸ”„ é¡µé¢æ•°æ®å·²åˆ·æ–°', 'info');
            }, 1000);
          } else {
            addLog(`âŒ åŒæ­¥å¤±è´¥: ${result.error}`, 'error');
          }
        } catch (error) {
          addLog(`âŒ åŒæ­¥å¼‚å¸¸: ${error.message}`, 'error');
          // å¦‚æœæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå›é€€åˆ°æœ¬åœ°æ¨¡æ‹Ÿ
          addLog('âš ï¸ GitæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹ŸåŒæ­¥', 'warning');
          const localResult = await gitManager.syncFromRemote();
          if (localResult.success) {
            addLog(`âœ… ${localResult.message}`, 'success');
          }
        }
      }

      function showBackupHistory() {
        if (!gitManager) {
          addLog('âŒ Gitç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
          return;
        }

        const backups = gitManager.getBackupHistory();

        if (backups.length === 0) {
          alert('æš‚æ— å¤‡ä»½å†å²');
          return;
        }

        let historyText = 'ğŸ“¦ å¤‡ä»½å†å²è®°å½•ï¼š\n\n';
        backups.forEach((backup, index) => {
          const date = new Date(backup.timestamp).toLocaleString();
          historyText += `${index + 1}. ${date} - ${backup.message}\n`;
        });

        // åˆ›å»ºä¸€ä¸ªå¯é€‰æ‹©çš„å¤‡ä»½åˆ—è¡¨
        const backupList = backups.map((backup, index) =>
          `<option value="${index}">${new Date(backup.timestamp).toLocaleString()} - ${backup.message}</option>`
        ).join('');

        const modalHtml = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
              <h3>ğŸ“¦ å¤‡ä»½å†å²</h3>
              <select id="backup-select" style="width: 100%; height: 150px; margin: 10px 0;" multiple>
                ${backupList}
              </select>
              <div style="margin-top: 15px;">
                <button onclick="restoreFromBackup()" class="small-button">æ¢å¤é€‰ä¸­å¤‡ä»½</button>
                <button onclick="closeBackupModal()" class="small-button">å…³é—­</button>
              </div>
            </div>
          </div>
        `;

        const modalDiv = document.createElement('div');
        modalDiv.innerHTML = modalHtml;
        modalDiv.id = 'backup-modal';
        document.body.appendChild(modalDiv);
      }

      async function restoreFromBackup() {
        const select = document.getElementById('backup-select');
        if (!select.value) {
          alert('è¯·é€‰æ‹©ä¸€ä¸ªå¤‡ä»½');
          return;
        }

        const backupIndex = parseInt(select.value);

        if (!gitManager) {
          addLog('âŒ Gitç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
          return;
        }

        if (confirm('ç¡®å®šè¦æ¢å¤è¿™ä¸ªå¤‡ä»½å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ã€‚')) {
          addLog('ğŸ”„ å¼€å§‹æ¢å¤æ•°æ®...', 'info');

          try {
            const result = await gitManager.restoreFromBackup(backupIndex);

            if (result.success) {
              addLog(`âœ… ${result.message}`, 'success');
              closeBackupModal();

              // é‡æ–°åŠ è½½é¡µé¢
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } else {
              addLog(`âŒ æ¢å¤å¤±è´¥: ${result.error}`, 'error');
            }
          } catch (error) {
            addLog(`âŒ æ¢å¤å¼‚å¸¸: ${error.message}`, 'error');
          }
        }
      }

      function closeBackupModal() {
        const modal = document.getElementById('backup-modal');
        if (modal) {
          modal.remove();
        }
      }

      // è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
      function enableAutoBackup() {
        if (gitManager) {
          gitManager.setAutoBackup(true);
          addLog('ğŸ”„ è‡ªåŠ¨å¤‡ä»½å·²å¯ç”¨', 'info');
        }
      }

      function disableAutoBackup() {
        if (gitManager) {
          gitManager.setAutoBackup(false);
          addLog('â¸ï¸ è‡ªåŠ¨å¤‡ä»½å·²ç¦ç”¨', 'info');
        }
      }
    </script>
  </body>
</html>
